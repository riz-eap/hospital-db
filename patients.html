<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MediCore HMS - Patients</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Roboto',sans-serif;background:#121212;color:#fff;display:flex;height:100vh;overflow:hidden;}

    /* Sidebar */
    .sidebar{width:250px;background:#1f1f30;padding:20px;display:flex;flex-direction:column;}
    .sidebar h2{color:#fff;text-align:center;margin-bottom:25px;}
    .sidebar a{display:block;color:#ccc;padding:12px 15px;margin-bottom:8px;text-decoration:none;border-radius:6px;transition:0.3s;}
    .sidebar a.active,.sidebar a:hover{background:#2e2e50;color:#fff;}
    .sidebar button{margin-top:auto;padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;transition:0.3s;}
    .sidebar button:hover{background:#c0392b;}

    /* Main content */
    .main{flex:1;padding:25px;overflow-y:auto;}
    .main h2{margin-bottom:20px;color:#fff;}

    /* Form */
    form{margin-bottom:20px;background:#1e1e2f;padding:20px;border-radius:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    form input, form select, form button{padding:10px;border:none;border-radius:6px;font-size:14px;}
    form input, form select{flex:1;}
    form button{background:#1abc9c;color:#121212;cursor:pointer;transition:0.3s;font-weight:500;}
    form button:hover{background:#16a085;}

    /* Table */
    table{width:100%;border-collapse:collapse;margin-top:20px;border-radius:10px;overflow:hidden;background:#1f1f30;}
    th, td{padding:12px 15px;text-align:center;border-bottom:1px solid #333;}
    th{background:#2a2a40;color:#fff;font-weight:500;}
    tr:nth-child(even){background:#23233f;}
    tr:hover{background:#2e2e50;}
    td[contenteditable="true"]{background:#2a2a40;cursor:text;}

    /* Action buttons */
    button.action-btn{padding:6px 10px;border:none;border-radius:6px;margin:0 3px;cursor:pointer;transition:0.3s;}
    button.save-btn{background:#1abc9c;color:#121212;}
    button.save-btn:hover{background:#16a085;}
    button.delete-btn{background:#e74c3c;color:#fff;}
    button.delete-btn:hover{background:#c0392b;}

    /* Highlight critical patients */
    .critical{color:#e74c3c;font-weight:700;}
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>MediCore HMS</h2>
    <a href="/index.html">Dashboard</a>
    <a href="/patients.html" class="active">Patients</a>
    <a href="/staff.html">Staff</a>
    <a href="/appointments.html">Appointments</a>
    <a href="/medicines.html">Medicines</a>
    <a href="/settings.html">Settings</a>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Main Content -->
  <div class="main">
    <h2>Patients</h2>
    <form id="add-patient-form">
      <input type="text" id="name" placeholder="Name" required>
      <input type="number" id="age" placeholder="Age" required>
      <select id="gender"><option value="M">Male</option><option value="F">Female</option></select>
      <input type="date" id="admission_date" required>
      <input type="text" id="doctor" placeholder="Doctor">
      <select id="status"><option>stable</option><option>critical</option></select>
      <button type="submit">Add Patient</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Age</th>
          <th>Admission Date</th>
          <th>Doctor</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="patients-tbody"></tbody>
    </table>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user) window.location.href='/login.html';

    function logout(){
      fetch('/logout',{method:'POST'}).finally(()=>{
        localStorage.removeItem('user');
        window.location.href='/login.html';
      });
    }

    async function loadPatients(){
      try{
        const data = await fetch('/patients').then(r=>r.json());
        const tbody = document.getElementById('patients-tbody'); tbody.innerHTML='';
        data.forEach(p=>{
          const criticalClass = p.status.toLowerCase() === 'critical' ? 'critical' : '';
          tbody.innerHTML+=`
            <tr>
              <td>${p.id}</td>
              <td contenteditable="true" data-field="name">${p.name}</td>
              <td contenteditable="true" data-field="age">${p.age}</td>
              <td>${p.admission_date}</td>
              <td contenteditable="true" data-field="doctor">${p.doctor||''}</td>
              <td contenteditable="true" data-field="status" class="${criticalClass}">${p.status}</td>
              <td>
                <button class="action-btn save-btn" onclick="updatePatient(${p.id}, this)">Save</button>
                <button class="action-btn delete-btn" onclick="deletePatient(${p.id})">Delete</button>
              </td>
            </tr>`;
        });
      } catch(err){ console.error('Error loading patients', err); }
    }

    async function updatePatient(id,btn){
      const row = btn.closest('tr');
      const body = {
        name: row.querySelector('[data-field="name"]').innerText,
        age: row.querySelector('[data-field="age"]').innerText,
        gender: gender.value, // can be enhanced to editable
        doctor: row.querySelector('[data-field="doctor"]').innerText,
        status: row.querySelector('[data-field="status"]').innerText
      };
      await fetch(`/patients/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      loadPatients();
    }

    async function deletePatient(id){
      if(!confirm('Delete patient?')) return;
      await fetch(`/patients/${id}`, {method:'DELETE'});
      loadPatients();
    }

    document.getElementById('add-patient-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const body = {
        name: name.value,
        age: age.value,
        gender: gender.value,
        admission_date: admission_date.value,
        doctor: doctor.value,
        status: status.value
      };
      await fetch('/patients/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      loadPatients(); e.target.reset();
    });

    window.onload = loadPatients;
  </script>
</body>
</html>
